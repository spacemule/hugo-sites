<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Simple repository caching on openSUSE :: spacemule.net</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="One of the things I missed the most from my Debian/Ubuntu days when I switched to openSUSE about a year ago was apt-cacher-ng with proxy autodiscovery. I had apt-cacher-ng running on one computer at home, and all of my containers, VMs, and laptops would use that proxy when they were on the home network. Even better, they&amp;rsquo;d seemlessly switch back to the default repos if the proxy was unavailable.
To be clear, what I want is to have my computers use apt-cacher-ng as a proxy when available to download packages." />
<meta name="keywords" content="linux opensuse podman containers kubernetes k8s" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://spacemule.net/posts/repo-cache/" />




<link rel="stylesheet" href="https://spacemule.net/assets/style.css">

  <link rel="stylesheet" href="https://spacemule.net/assets/green.css">






<link rel="apple-touch-icon" href="https://spacemule.net/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://spacemule.net/../favicon.ico">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Simple repository caching on openSUSE">
<meta property="og:description" content="One of the things I missed the most from my Debian/Ubuntu days when I switched to openSUSE about a year ago was apt-cacher-ng with proxy autodiscovery. I had apt-cacher-ng running on one computer at home, and all of my containers, VMs, and laptops would use that proxy when they were on the home network. Even better, they&amp;rsquo;d seemlessly switch back to the default repos if the proxy was unavailable.
To be clear, what I want is to have my computers use apt-cacher-ng as a proxy when available to download packages." />
<meta property="og:url" content="https://spacemule.net/posts/repo-cache/" />
<meta property="og:site_name" content="spacemule.net" />

  
    <meta property="og:image" content="https://spacemule.net/../favicon.ico">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

  <meta property="article:section" content="linux" />


  <meta property="article:published_time" content="2022-01-04 15:53:06 &#43;0200 IST" />












</head>
<body class="green">


<div class="container full headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo"><img src="/logo.webp" style="height: 3ex">
    spacemule.net
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/categories">Categories</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
        
          <li><a href="https://github.com/spacemule">Github</a></li>
        
      
        
          <li><a href="/about">About Me</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">Show more ▾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="https://zahava-is.cool">Zahava is Cool</a></li>
              
            
          </ul>
        </ul>
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/categories">Categories</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
      
        <li><a href="https://github.com/spacemule">Github</a></li>
      
    
      
        <li><a href="/about">About Me</a></li>
      
    
      
        <li><a href="https://zahava-is.cool">Zahava is Cool</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://spacemule.net/posts/repo-cache/">Simple repository caching on openSUSE</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-01-04
        
      </span>
    
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://spacemule.net/tags/linux/">linux</a>&nbsp;
    
    #<a href="https://spacemule.net/tags/opensuse/">openSUSE</a>&nbsp;
    
    #<a href="https://spacemule.net/tags/apt-cacher-ng/">apt-cacher-ng</a>&nbsp;
    
    #<a href="https://spacemule.net/tags/caching-proxy/">caching proxy</a>&nbsp;
    
  </span>
  
  


  

  <div class="post-content"><div>
        <p>One of the things I missed the most from my Debian/Ubuntu days when I switched to openSUSE about a year ago was apt-cacher-ng with proxy autodiscovery. I had apt-cacher-ng running on one computer at home, and all of my containers, VMs, and laptops would use that proxy when they were on the home network. Even better, they&rsquo;d seemlessly switch back to the default repos if the proxy was unavailable.</p>
<p>To be clear, what I want is to have my computers use apt-cacher-ng as a proxy when available to download packages. When it&rsquo;s unavailable either due to downtime, a bug, or me being on a different network, I want zypper to default to the standard repos.</p>
<p>I tried to find the proper way to do this on openSUSE. I asked on reddit and telegram, but found no reasonable solutions. I tried creating a transparent caching proxy with squid and some iptables rules, but due to zypper downloading from multiple repositories simultaneously, it needed a lot of hacks to cache the rpms properly. I wasn&rsquo;t willing to risk a duct-taped together solution that could break any day. I tried writing a service for libzypp, but found the documentation unclear and lacking useful examples. Finally, I found a solution so simple I&rsquo;m surprised I haven&rsquo;t seen it published elsewhere.</p>
<p>After playing with this for a few months on and off I wondered what the spec actually requires of a <code>.repo</code> file, and I found <a href="https://www.suse.com/support/kb/doc/?id=000019926">this gem on SUSE&rsquo;s site</a>. You can specify more than one <code>baseurl</code>, and their order sets their priority. I looked at the <a href="https://www.mankier.com/8/zypper#Commands-Supported_URI_formats">manpage for zypper</a> and found that a proxy can be defined in the URI.</p>
<p>The solution is as simple as editing the repo file and adding a <code>baseurl</code> before the others pointing to apt-cacher-ng. For reference, here&rsquo;s one of my <code>.repo</code> files:</p>
<pre><code>[repo-oss]
name=openSUSE-Tumbleweed-Oss
enabled=1
autorefresh=1
path=/
baseurl=http://download.opensuse.org/tumbleweed/repo/oss/?proxy=10.42.0.1:3128
baseurl=http://download.opensuse.org/tumbleweed/repo/oss/
keeppackages=0
</code></pre><p>I have noticed the occasional 404 error in the proxy that shouldn&rsquo;t be happening. The errors only seem to occur with metadata files and not the actual packages, so it&rsquo;s serving its main purpose and saving me plenty of time and our cell connection to the internet plenty of bandwidth.</p>

      </div></div>

  
  
  

  

</div>

  </div>

  
    <footer class="footer">
  spacemule.net: Delivering goods across inter-dimensional boundaries
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://spacemule.net/assets/main.js"></script>
<script src="https://spacemule.net/assets/prism.js"></script>







  
</div>

</body>
</html>
